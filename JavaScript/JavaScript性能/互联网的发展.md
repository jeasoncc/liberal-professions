# 前言

当 JavaScript 作为 Netscape Naviator 浏览器的一部分首次出现在 1996 年时，性能问题并不重要。当时的互联网仍处在发展期，各个方面都很慢。从拨号上网到低配置的家用电脑，上网冲浪往往比任何事情都需要耐心。人们做好了等待网页加载的准备，页面能加载完成就是一件值得庆祝的事情了。

> 说明了 JavaScript 诞生之处的性能问题不是问题，人们也不期待性能问题。

JavaScript 的最初目标是改善网页的用户体验。JavaScript 能代替服务器处理页面中类似表单验证的简单任务，这些做节省了服务器连接的大量时间。想象一下你填完一个很长的表单，提交后等待了 30～60秒，却得到了一个字段出错的信息是什么感觉。显而易见，JavaScript 为早期的互联网用户节省了很多的时间。

> 介绍了 JavaScript 诞生之初的价值：为用户节省服务器校验时间。

## 互联网的发展

在接下来的 10 年里，电脑和互联网不断发展。首先，两者都变得很快。高速的微处理器，内存的廉价供应，以及光纤的出现将互联网推向了一个新的时代。随着高速网络的普及，网页开始变得丰富，并且承载真更多的信息和多媒体内容。Web 从简单的关联文档演变成了各式各样的设计和界面。一切都变了，除了一样东西，那就是 JavaScript。

> 介绍了 JavaScript 的发展，网页变得越来越丰富，各项硬件设施也变得高效起来。这个时候 JavaScript 的性能就是一项问题。

这项曾用于节省服务器消耗的技术日益普及，但代码也从数十行的发展到成百上千行。IE 4 和动态 HTML——改变页面显示而无需重新加载的技术——的推出更是使得网页中的 JavaScript 代码只增不减。

> 随着发展，JavaScript 代码量极大的增加，这会导致性能问题。

最近一次浏览器的重大更新是文档对象模型（DOM）的推出，这是一个被 IE 5，Netscape 6，以及 Opera 所一致接受的动态 HTML 接口。紧接着，JavaScript 被标准化，并推出了 ECMA-262 第三版。<u>随着所有浏览器都支持 DOM，同时提供了通过对 JavaScript 的支持——或多或少，Web 应用平台诞生了。</u>尽管有如此巨大的飞跃，有了编写 JavaScript 的通用 API，但是负责执行 JavaScript 引擎几乎没有变化。

> 浏览器变成了应用平台，这是概念上的转变，这个时候，JavaScript 性能就更加是个值得关注的问题。

## 为什么优化是必要的

在 1996 年，JavaScript 引擎只要能支持页面里数十行的 JavaScript 代码就好，而今天，却运行成千上万行 JavaScript 代码的 Web 应用。从许多方面来说，如果不是因为浏览器自身在语言管理和基础设施方面的落后，JavaScript 本可能取得更大规模的成功。<u>IE 6 就是一个明证，发布之初，它的稳定性和性能都被人称颂，但后来却因为自身的 Bug 和 反应迟钝而被痛批令人讨厌的 Web 应用平台。</u>

> IE 6 没有改变，却因为代码量的增加而被显出变得缓慢。

事实上，IE 6 并没有变慢，它只是被寄予了厚望。 2001 年 IE 6 刚发布时出现的各类早期 Web 应用比 2005 年后出现应用更轻量，JavaScript 代码也远没有那么多。JavaScript 代码数量的增长带来的影响变得明显，IE 6 的 JavaScript 引擎吃不消了，原因在于它的「静态垃圾回收机制」。该引擎检视内存中固定数量的对象来确定何时进行垃圾回收。早期的 Web 应用开发人员很少遇到这个极限值，随着更多的 JavaScript 代码产生越来越多的对象，复杂的 Web 应用开始频繁遭遇这个门槛。<u>问题变得清晰起来：JavaScript 开发人员和 Web 应用在发展，而 JavaScript 引擎却没有。</u>

> 问题变得清晰起来：JavaScript 开发人员和 Web 应用在发展，而 JavaScript 引擎却没有。

尽管其他浏览器有着**更加完善的垃圾回收机制和更好的运行性能**，但大多数仍然使用 JavaScript 解释器来执行代码。解释性代码天生就没有编译器代码块，因为解释性代码必须经历代码转化计算机指令的过程。无论解释器怎样优化和多么智能，它总是会带来一些性能损耗。

> 放屁，JavaScript 需要编译器、引擎、词法作用域的互相配合。编译器啊！！！

编译器已经有了各种各样的优化，使得开发人员可以按照他们想要的方式编写代码，而不需要担心是否最优。编译器可以基于词法分析判断代码究竟想要做什么，然后产出能完成任务的运行最快的机器码来进行优化。解释器很少有这样的优化，这很大程度是意味着，代码怎么写，就被怎么执行。

> JavaScript 是有编译器的。

实际上，通常在其他语言中由编译器处理的优化，在 JavaScript 中却要求开发人员来完成。

> 不知道他这句话是针对哪一年说得。

## 下一代 JavaScript 引擎

2008 年，JavaScript 引来了第一次大的性能升级。 Google 发布了全新的浏览器，名为 Chrome。Chrome 是第一款采用优化后的 JavaScript 引擎的浏览器，该引擎的研发代号为 V8，V8 是一款为 JavaScript 打造的 JIT 编译引擎。它把 JavaScript 代码转为机器码来执行，所以给人的感觉是 JavaScript 的执行速度超快。

> V8 是第一款 JavaScript 编译器？奇怪的知识又增加了。

其他浏览器紧跟着也做了 JavaScript 引擎，Safari 发布了 Nitro 的 JIT JavaScript 引擎，而 Firefox 的 TraceMonkey 引擎对频繁执行的代码做了优化。

> 看样子，大家都在向 Google 看齐。GOOD GOOD！！！

这些全新的 JavaScript 引擎带来的是编译器层面的优化，这也是它应该做的。或许有一天，开发人员完全无需关心代码的性能优化。可是，那一天还没有到来。

## 性能仍需要关注

尽管核心 JavaScript 的执行速度已经有所提高，但 JavaScript 仍然有多个方面的问题在新的引擎中没有被处理。网络延迟导致迟滞的影响页面外观的操作尚未浏览器的充分优化。尽管诸如函数内联、代码何合并以及字符串连接算法简单的优化很通过编译器进行优化，但对动态且多层结构的 Web 应用程序来说，这些优化只能解决部分的性能。

> 多层的个啥意思。
>
> 动态好理解。

然而全新的 JavaScript 引擎让我们看到未来高速互联网的模样，在可预见的未来，当今性能话题仍然具有相关性和重要性。

> 性能问题未来也不可能不是个问题！

我将讨论的技术和方案涉及 JavaScript 的各个方面，内容涵盖<u>运行时间</u>、<u>下载</u>、<u>DOM操作</u>、<u>页面生存周期</u>等。这些话题仅仅是一部分，它们相关的核心性能可能随着 JavaScript 的不断进步而变得无关紧要，但这还有待时日。

> - 运行时间
> - 下载
> - DOM 操作
> - 页面生存周期

其他的话题则针对那些更快的 JavaScript 引擎也力不能及的方面：<u>DOM 交互</u>、<u>网络延迟</u>、<u>JavaScript 阻塞</u>和<u>并发下载</u>等。这些话题在未来依然重要，而且还会再受到更大关注，它们需要从底层研究 JavaScript 执行时间才能继续提高。

> - DOM 交互
> - 网络延迟
> - JavaScript 阻塞
> - 并发下载

---

# 本书的组织

本书的章节组织方式基于一个正常的 JavaScript 开发周期。

- 最开始的第 1 章讨论页面加载 JavaScript 的最佳方式。
- 第 2 章到第 8 章专注于那些你的 JavaScript 代码尽可能高效运行的编程方式。
- 第 9 章讨论构建和部署 JavaScript 文件到生产环境的最佳方式。
- 第 10 章提到的性能工具能帮助你找出代码部署后的潜在问题。

> 按照开发周期来组织书的结构。
>
> 很棒的思路。
>
> 我也可以按照写文章的周期来安排「章节组织方式」。

## JavaScript 加载

第 1 章，「加载和执行」，从 JavaScript 的基础开始：把代码加载到页面，要提高 JavaScript 的性能，首先要<u>用最高效的方式加载代码到页面中</u>。本章专注于加载 JavaScript 代码相关的性能问题，并给出的几种方法以减轻它的负面影响。

## 编码技术

<u>JavaScript 中大量性能问题的来源是因为使用抵效的算法或工具编写出糟糕代码</u>。接下来的 7 个章节专注于找出问题代码并给出更快替代方案来完成相同的任务。

> 这句话引出了算法的需求。

第 2 章的「数据访问」，重点<u>介绍了 JavaScript 如何存取脚本里的数据</u>，数据的储存位置同数据类型同样重要，本章解释了作用域链和原型链对脚本整体性能的影响。

> 如何存取脚本里的数据？
>
> 我想都没想过这个问题。这似乎是某种自然而然的东西。

第 4 章「算法和流控制」，解释了常用的编程模式（比如迭代和循环）是如何影响运行期性能的。本章还讨论了 优化技术以及浏览器的 JavaScript 运行期限制。

> 迭代、循环影响性能的问题，妈的，想都没想过。

第 5 章 介绍了字符串和正则表达式，Web 人员已经和浏览器低效的字符串奋战多年，这一章解释了字符串操作起来会很慢，以及如何应对。

> 有的字符串比较慢吗？都没听说过啊！！！

第 6 章「快速响应的用户界面」，聚焦于用户体验。JavaScript 可能对导致浏览器假死，让用户感到无比沮丧。

第 7 章：「Ajax」，讨论了客户端——服务端快速通信的最佳方法。

第 8 章：「编程实践」介绍了一些专门针对 JavaScript 的最佳实践。

## 部署

JavaScript 代码一旦完成编写并通过测试，就是时候向用户发布了。然而，你不应当直接把源码直接放在生产环境。第 9 章「构建和部署高性能 JavaScript 应用」中介绍了如何用用一个构建系统去自动压缩文件，并使用 HTTP 压缩传输内容到浏览器。

## 测试

<u>当所有 JavaScript 代码部署完成，下一步就要开始性能测试。</u>第 10 章「工具」里内容涵盖了测试方法论和相关工具，他介绍了如何使用 JavaScript 来衡量性能，还描述了两类通用工具，一类用于评估 JavaScript 运行期性能，一类通过使用 HTTP 嗅探来发现隐藏的性能问题。

> JavaScript 代码测试我之前用到的很少，以后应该注重测试代码。

## 本书读者

本书面向有<u>中高级 JavaScript 经验</u>并希望提升 Web 应用性能的 Web 开发人员。

> 哈哈，老子是中高级 JavaScript 经验。

## 本书的约定

## 代码用例

## 意见和问题

## 致谢

